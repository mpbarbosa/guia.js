name: Documentation Quality Check

on:
  pull_request:
    paths:
      - '**.md'
      - '.markdownlint.json'
      - '.github/workflows/documentation-lint.yml'
  push:
    branches:
      - main
    paths:
      - '**.md'

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v13
        with:
          globs: '**/*.md'
          config: '.markdownlint.json'
  
  link-check:
    name: Link Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'no'
          use-verbose-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
          check-modified-files-only: 'yes'
  
  line-number-check:
    name: Deprecation Check (Line Numbers)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check for line number references
        run: |
          echo "Checking for line number references in documentation..."
          
          # Pattern: "lines 123-456" or "line 123"
          VIOLATIONS=$(grep -rn "line[s]* [0-9]" docs/ .github/ --include="*.md" || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "❌ Found line number references (deprecated):"
            echo "$VIOLATIONS"
            echo ""
            echo "Line numbers become stale quickly. Use module/file references instead."
            echo "Example: Instead of 'lines 62-666', use 'src/core/GeoPosition.js'"
            exit 1
          else
            echo "✅ No line number references found"
          fi
  
  badge-sync-check:
    name: Badge Synchronization
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Extract test count
        id: test-count
        run: |
          TEST_COUNT=$(npm test 2>&1 | grep -oP 'Tests:.*?\K\d+(?= passed)' | head -1 || echo "0")
          echo "count=$TEST_COUNT" >> $GITHUB_OUTPUT
          echo "Actual test count: $TEST_COUNT"
      
      - name: Check badge accuracy
        run: |
          DOCUMENTED=$(grep -oP 'tests-\K\d+' README.md | head -1)
          ACTUAL="${{ steps.test-count.outputs.count }}"
          
          echo "Documented in badge: $DOCUMENTED"
          echo "Actual from tests: $ACTUAL"
          
          if [ "$DOCUMENTED" != "$ACTUAL" ]; then
            echo "⚠️ Badge is out of date!"
            echo "Run: ./.github/scripts/update-badges.sh"
            # Don't fail - just warn
          else
            echo "✅ Badge is accurate"
          fi
  
  version-consistency:
    name: Version Consistency
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Check version consistency
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Package version: $VERSION"
          
          ERRORS=0
          FILES="README.md docs/INDEX.md .github/copilot-instructions.md src/config/defaults.js"
          
          for file in $FILES; do
            if [ ! -f "$file" ]; then
              echo "⚠️ $file not found, skipping"
              continue
            fi
            
            if ! grep -q "$VERSION" "$file"; then
              echo "❌ $file: Version mismatch or missing"
              ERRORS=$((ERRORS + 1))
            else
              echo "✅ $file"
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "Fix: Update version in all files to $VERSION"
            exit 1
          fi
          
          echo ""
          echo "✅ All versions consistent: $VERSION"
