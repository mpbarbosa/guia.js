name: Modified Files - Test and Documentation Updates

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-changes:
    name: Detect File Changes
    runs-on: ubuntu-latest
    outputs:
      js_files: ${{ steps.filter.outputs.js }}
      test_files: ${{ steps.filter.outputs.tests }}
      doc_files: ${{ steps.filter.outputs.docs }}
      src_changed: ${{ steps.filter.outputs.src }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: filter
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check for JavaScript files
          if echo "$CHANGED_FILES" | grep -q "\.js$"; then
            echo "js=true" >> $GITHUB_OUTPUT
          else
            echo "js=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for test files
          if echo "$CHANGED_FILES" | grep -q "__tests__.*\.js$"; then
            echo "tests=true" >> $GITHUB_OUTPUT
          else
            echo "tests=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for documentation files
          if echo "$CHANGED_FILES" | grep -qE "\.md$"; then
            echo "docs=true" >> $GITHUB_OUTPUT
          else
            echo "docs=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for src files
          if echo "$CHANGED_FILES" | grep -q "^src/.*\.js$"; then
            echo "src=true" >> $GITHUB_OUTPUT
          else
            echo "src=false" >> $GITHUB_OUTPUT
          fi

  run-affected-tests:
    name: Run Tests for Modified Files
    needs: detect-changes
    if: needs.detect-changes.outputs.js_files == 'true' || needs.detect-changes.outputs.test_files == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run all tests
        run: npm test
        continue-on-error: true
      
      - name: Run tests with coverage
        run: npm run test:coverage
        continue-on-error: true
        
      - name: Validate JavaScript syntax
        run: npm run validate

  update-test-documentation:
    name: Update Test Documentation
    needs: [detect-changes, run-affected-tests]
    if: needs.detect-changes.outputs.test_files == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate test statistics
        id: test_stats
        run: |
          # Run tests and capture output
          npm test -- --json --outputFile=test-results.json || true
          
          # Count test files
          TEST_FILES=$(find __tests__ -name "*.test.js" -o -name "*.spec.js" | wc -l)
          echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT
          
          # Parse test results if available
          if [ -f test-results.json ]; then
            # Extract test counts (simple approach)
            TOTAL_TESTS=$(npm test 2>&1 | grep -oP '\d+(?= total)' | head -1 || echo "N/A")
            PASSED_TESTS=$(npm test 2>&1 | grep -oP '\d+(?= passed)' | head -1 || echo "N/A")
            echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
            echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          fi
          
      - name: Update TESTING.md with statistics
        run: |
          # Create a temporary update script
          cat > /tmp/update_testing_md.sh << 'EOF'
          #!/bin/bash
          TESTING_FILE="TESTING.md"
          
          # Check if TESTING.md exists
          if [ ! -f "$TESTING_FILE" ]; then
            echo "TESTING.md not found, skipping update"
            exit 0
          fi
          
          # Get current date
          CURRENT_DATE=$(date +"%Y-%m-%d")
          
          # Add automation notice if not present
          if ! grep -q "Last updated automatically" "$TESTING_FILE"; then
            echo "" >> "$TESTING_FILE"
            echo "---" >> "$TESTING_FILE"
            echo "" >> "$TESTING_FILE"
            echo "_Last updated automatically: $CURRENT_DATE_" >> "$TESTING_FILE"
          else
            # Update existing date
            sed -i "s/_Last updated automatically:.*/_Last updated automatically: $CURRENT_DATE_/" "$TESTING_FILE"
          fi
          
          echo "âœ… TESTING.md updated with current date"
          EOF
          
          chmod +x /tmp/update_testing_md.sh
          /tmp/update_testing_md.sh
          
      - name: Commit documentation updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add TESTING.md
            git commit -m "docs: auto-update TESTING.md [skip ci]"
            git push
          fi

  validate-documentation:
    name: Validate Modified Documentation
    needs: detect-changes
    if: needs.detect-changes.outputs.doc_files == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get changed markdown files
        id: changed_docs
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_DOCS=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep "\.md$" || echo "")
          else
            CHANGED_DOCS=$(git diff --name-only HEAD~1 HEAD | grep "\.md$" || echo "")
          fi
          
          echo "Changed documentation files:"
          echo "$CHANGED_DOCS"
          echo "files=$CHANGED_DOCS" >> $GITHUB_OUTPUT
          
      - name: Validate markdown syntax
        run: |
          echo "Validating markdown files..."
          
          # Basic markdown validation
          for file in ${{ steps.changed_docs.outputs.files }}; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              
              # Check for common issues
              if grep -q $'\r' "$file"; then
                echo "âš ï¸ Warning: $file contains Windows line endings"
              fi
              
              # Check for broken internal links (basic)
              INTERNAL_LINKS=$(grep -oP '\[.*?\]\((?!http)[^\)]+\)' "$file" || true)
              if [ ! -z "$INTERNAL_LINKS" ]; then
                echo "Found internal links in $file:"
                echo "$INTERNAL_LINKS" | while read link; do
                  LINK_PATH=$(echo "$link" | grep -oP '\([^\)]+\)' | tr -d '()')
                  if [ ! -f "$LINK_PATH" ] && [ ! -d "$LINK_PATH" ]; then
                    echo "âš ï¸ Potential broken link: $LINK_PATH"
                  fi
                done
              fi
              
              echo "âœ… $file validation complete"
            fi
          done
          
      - name: Check documentation index
        run: |
          # Check if docs/INDEX.md needs updating
          if [ -f "docs/INDEX.md" ]; then
            echo "Checking if docs/INDEX.md references are up to date..."
            
            # List all markdown files
            MD_FILES=$(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*")
            
            echo "Documentation files in repository:"
            echo "$MD_FILES"
            
            echo "âœ… Documentation index check complete"
          fi

  update-coverage-badge:
    name: Update Test Coverage Statistics
    needs: [detect-changes, run-affected-tests]
    if: needs.detect-changes.outputs.src_changed == 'true' || needs.detect-changes.outputs.test_files == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate coverage report
        run: npm run test:coverage
        continue-on-error: true
        
      - name: Extract coverage statistics
        id: coverage
        run: |
          # Check if coverage directory exists
          if [ -d "coverage" ]; then
            echo "Coverage report generated"
            
            # Try to extract coverage percentage from coverage summary
            if [ -f "coverage/coverage-summary.json" ]; then
              # Install jq if needed for JSON parsing
              echo "Coverage summary found"
            fi
          else
            echo "No coverage report generated"
          fi
          
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ“Š Test coverage report would be posted here"
          echo "This step can be enhanced with actual coverage reporting"

  summary:
    name: Workflow Summary
    needs: [detect-changes, run-affected-tests, validate-documentation]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## File Modification Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Detected:" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript files: ${{ needs.detect-changes.outputs.js_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test files: ${{ needs.detect-changes.outputs.test_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation files: ${{ needs.detect-changes.outputs.doc_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- Source files: ${{ needs.detect-changes.outputs.src_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Jobs Status:" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.run-affected-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation validation: ${{ needs.validate-documentation.result }}" >> $GITHUB_STEP_SUMMARY
