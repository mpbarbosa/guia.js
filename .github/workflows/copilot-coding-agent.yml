name: Copilot Coding Agent

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Validate JavaScript syntax
      uses: ./.github/actions/validate-js
      with:
        files: 'src/guia.js src/guia_ibge.js'
        
    - name: Test basic functionality
      run: |
        echo "Testing basic Node.js functionality..."
        node src/guia.js
        echo "✅ Basic functionality test passed"
        
    - name: Start web server and test (basic check)
      run: |
        echo "Starting web server for basic connectivity test..."
        python3 -m http.server 9000 &
        SERVER_PID=$!
        sleep 3
        echo "Testing server connectivity..."
        curl -s http://localhost:9000/ || echo "Server not responding (expected - no index.html)"
        
        # Test if test.html loads properly
        if curl -s http://localhost:9000/test.html | grep -q "Guia.js"; then
          echo "✅ test.html loads correctly"
        else
          echo "⚠️ test.html not found or corrupted"
        fi
        
        kill $SERVER_PID
        echo "✅ Web server test completed"
        
    - name: Check for required files
      run: |
        echo "Verifying required files exist..."
        test -f src/guia.js && echo "✅ src/guia.js found"
        test -f src/guia_ibge.js && echo "✅ src/guia_ibge.js found"
        test -f test.html && echo "✅ test.html found"
        test -f .github/copilot-instructions.md && echo "✅ copilot-instructions.md found"
        test -f .github/workflows/copilot-coding-agent.yml && echo "✅ copilot-coding-agent.yml found"
        echo "✅ All required files present"

  lint-and-format:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Check code style (basic)
      run: |
        echo "Performing basic code style checks..."
        # Check for basic formatting issues
        if grep -q $'\t' src/guia.js; then
          echo "✅ Tabs found in src/guia.js (consistent with existing style)"
        fi
        
        # Check for console.log statements (informational)
        console_logs=$(grep -c "console\." src/guia.js || true)
        echo "ℹ️ Found $console_logs console statements in src/guia.js"
        
        # Check version consistency
        if grep -q "prerelease: 'alpha'" src/guia.js; then
          echo "✅ Version configuration found in src/guia.js"
        fi
        
        echo "✅ Basic code style checks completed"

  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Basic security scan
      uses: ./.github/actions/security-check
      with:
        files: 'src/*.js'