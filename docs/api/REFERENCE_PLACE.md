# ReferencePlace API Documentation

**Version:** 0.8.7-alpha  
**File:** `src/data/ReferencePlace.js`  
**Author:** Marcelo Pereira Barbosa  
**Since:** 0.8.5-alpha  
**Version Info:** 0.7.1-alpha

## Overview

The `ReferencePlace` class encapsulates information about reference places such as shopping centers, subway stations, cafes, and other points of interest extracted from OpenStreetMap geocoding data. It provides Portuguese descriptions of place types based on OSM feature classes and types.

## Purpose

- Extract reference place data from geocoding responses
- Classify OSM features into human-readable Portuguese categories
- Provide contextual information about user location
- Support place-based navigation ("You are at Shopping Center XYZ")
- Calculate place categories for filtering and display

## Data Flow

```
Nominatim API Response (class, type, name)
            ↓
      ReferencePlace
            ↓
   Portuguese Description
   (e.g., "Shopping Center", "Estação do Metrô")
            ↓
    HTML Display Components
```

**Consumers:**
- `AddressExtractor` - Creates ReferencePlace from geocoding data
- `HTMLReferencePlaceDisplayer` - Renders place information in UI
- `BrazilianStandardAddress` - Contains reference place as property

---

## Class Definition

```javascript
import ReferencePlace from './data/ReferencePlace.js';

const refPlace = new ReferencePlace(geocodingData);
```

---

## Constructor

### `new ReferencePlace(data)`

Creates a new ReferencePlace instance from geocoding data and freezes it.

**Parameters:**
- `data` (`Object`) - Raw address data from geocoding API
  - `data.class` (`string`, optional) - OSM feature class (e.g., "shop", "amenity", "railway")
  - `data.type` (`string`, optional) - OSM feature type (e.g., "mall", "cafe", "subway")
  - `data.name` (`string`, optional) - Feature name (e.g., "Shopping Morumbi", "Estação Sé")

**Returns:** Frozen `ReferencePlace` instance

**Immutability:** Instance is frozen using `Object.freeze(this)` after creation

**Example:**
```javascript
const data = {
  class: 'shop',
  type: 'mall',
  name: 'Shopping Morumbi'
};

const refPlace = new ReferencePlace(data);
console.log(refPlace.description);    // "Shopping Center Shopping Morumbi"
console.log(refPlace.name);           // "Shopping Morumbi"
console.log(refPlace.className);      // "shop"
console.log(refPlace.typeName);       // "mall"

// Instance is frozen
console.log(Object.isFrozen(refPlace));  // true
```

---

## Properties

All properties are **public and read-only** (instance is frozen after creation):

| Property | Type | Description | Example |
|----------|------|-------------|---------|
| `className` | `string \| null` | OSM feature class | "shop", "amenity", "railway" |
| `typeName` | `string \| null` | OSM feature type | "mall", "cafe", "subway" |
| `name` | `string \| null` | Feature name | "Shopping Morumbi" |
| `description` | `string` | Portuguese description | "Shopping Center Shopping Morumbi" |

### Property Details

**`className`**
- OpenStreetMap feature class category
- Examples: "shop", "amenity", "railway", "place", "building"
- Used to determine the general category of the feature

**`typeName`**
- Specific type within the OSM class
- Examples: "mall", "cafe", "subway", "house", "yes"
- Provides detailed classification

**`name`**
- Human-readable name of the place
- Examples: "Shopping Morumbi", "Café do Ponto", "Estação Sé"
- May be null for unnamed features

**`description`**
- Calculated Portuguese description based on class/type mapping
- Automatically generated by `calculateDescription()` method
- Includes name when available
- Examples: "Shopping Center Shopping Morumbi", "Estação do Metrô"

---

## Static Properties

### `ReferencePlace.referencePlaceMap`

Reference place mapping for known OSM classes/types. Maps OpenStreetMap feature classes and types to Portuguese descriptions.

**Type:** `Object<string, Object<string, string>>`

**Structure:**
```javascript
{
  "osm-class": {
    "osm-type": "Portuguese Description"
  }
}
```

**Complete Mapping:**
```javascript
static referencePlaceMap = {
  "place": { 
    "house": "Residencial" 
  },
  "shop": {
    "mall": "Shopping Center",
    "car_repair": "Oficina Mecânica"
  },
  "amenity": { 
    "cafe": "Café" 
  },
  "railway": {
    "subway": "Estação do Metrô",
    "station": "Estação do Metrô"
  },
  "building": { 
    "yes": "Edifício" 
  }
};
```

**Valid Classes:** Defined in `src/config/defaults.js` as `VALID_REF_PLACE_CLASSES`
- `"place"` - Residential and location places
- `"shop"` - Commercial establishments
- `"amenity"` - Community facilities
- `"railway"` - Railway infrastructure
- `"building"` - Building structures

**Usage:**
```javascript
// Access mapping directly
const description = ReferencePlace.referencePlaceMap["shop"]["mall"];
console.log(description);  // "Shopping Center"

// Check if class/type is mapped
if (ReferencePlace.referencePlaceMap["amenity"]) {
  if (ReferencePlace.referencePlaceMap["amenity"]["cafe"]) {
    console.log("Café is mapped");
  }
}
```

---

## Public Methods

### `calculateCategory()`

Calculates the category of the reference place based on class and type.

**Returns:** `string` - Category name or "unknown"

**Logic:**
1. Look up class in `referencePlaceMap`
2. If class mapping is a string, return it
3. If class mapping is an object, look up type
4. Return category or "unknown" if not found

**Example:**
```javascript
const shopPlace = new ReferencePlace({
  class: 'shop',
  type: 'mall',
  name: 'Shopping Morumbi'
});

console.log(shopPlace.calculateCategory());  // "Shopping Center"

const amenityPlace = new ReferencePlace({
  class: 'amenity',
  type: 'cafe',
  name: 'Café do Ponto'
});

console.log(amenityPlace.calculateCategory());  // "Café"

const unknownPlace = new ReferencePlace({
  class: 'unknown',
  type: 'unknown'
});

console.log(unknownPlace.calculateCategory());  // "unknown"
```

**Use Cases:**
- Filter places by category
- Group places for display
- Determine icon or styling based on category

---

### `toString()`

Returns a string representation of the reference place.

**Returns:** `string` - Formatted string with description and name

**Format:**
- With name: `"ReferencePlace: <description> - <name>"`
- Without name: `"ReferencePlace: <description>"`

**Example:**
```javascript
const refPlace1 = new ReferencePlace({
  class: 'shop',
  type: 'mall',
  name: 'Shopping Morumbi'
});

console.log(refPlace1.toString());
// "ReferencePlace: Shopping Center Shopping Morumbi - Shopping Morumbi"

const refPlace2 = new ReferencePlace({
  class: 'amenity',
  type: 'cafe'
});

console.log(refPlace2.toString());
// "ReferencePlace: Café"
```

---

## Private Methods

### `calculateDescription()` (Private)

Calculates the Portuguese description of the reference place type. Automatically called by the constructor.

**Returns:** `string` - Portuguese description

**Logic:**
1. Check if className and typeName are present
2. Validate className is in `VALID_REF_PLACE_CLASSES`
3. Look up description in `referencePlaceMap`
4. If found and name exists, append name to description
5. If found without name, return description only
6. If not found, return `"className: typeName"` format
7. If invalid or missing, return `NO_REFERENCE_PLACE` constant

**Examples:**

**Case 1: Mapped with Name**
```javascript
// Input: class="shop", type="mall", name="Shopping Morumbi"
// Output: "Shopping Center Shopping Morumbi"
```

**Case 2: Mapped without Name**
```javascript
// Input: class="amenity", type="cafe", name=null
// Output: "Café"
```

**Case 3: Not Mapped**
```javascript
// Input: class="shop", type="furniture", name=null
// Output: "shop: furniture"
```

**Case 4: Invalid Class**
```javascript
// Input: class="invalid", type="unknown", name=null
// Output: "Não classificado" (NO_REFERENCE_PLACE constant)
```

---

## OSM Feature Classification

### Supported OSM Classes and Types

#### 1. **Place** (`class: "place"`)
| Type | Portuguese | Description |
|------|-----------|-------------|
| `house` | "Residencial" | Residential building |

**Example:**
```javascript
const home = new ReferencePlace({
  class: 'place',
  type: 'house',
  name: 'Casa do João'
});
console.log(home.description);  // "Residencial Casa do João"
```

---

#### 2. **Shop** (`class: "shop"`)
| Type | Portuguese | Description |
|------|-----------|-------------|
| `mall` | "Shopping Center" | Shopping mall |
| `car_repair` | "Oficina Mecânica" | Car repair shop |

**Example:**
```javascript
const mall = new ReferencePlace({
  class: 'shop',
  type: 'mall',
  name: 'Shopping Iguatemi'
});
console.log(mall.description);  // "Shopping Center Shopping Iguatemi"

const garage = new ReferencePlace({
  class: 'shop',
  type: 'car_repair',
  name: 'Auto Mecânica Silva'
});
console.log(garage.description);  // "Oficina Mecânica Auto Mecânica Silva"
```

---

#### 3. **Amenity** (`class: "amenity"`)
| Type | Portuguese | Description |
|------|-----------|-------------|
| `cafe` | "Café" | Café or coffee shop |

**Example:**
```javascript
const cafe = new ReferencePlace({
  class: 'amenity',
  type: 'cafe',
  name: 'Café Girondino'
});
console.log(cafe.description);  // "Café Café Girondino"
```

---

#### 4. **Railway** (`class: "railway"`)
| Type | Portuguese | Description |
|------|-----------|-------------|
| `subway` | "Estação do Metrô" | Subway station |
| `station` | "Estação do Metrô" | Train/Metro station |

**Example:**
```javascript
const metro = new ReferencePlace({
  class: 'railway',
  type: 'subway',
  name: 'Estação Sé'
});
console.log(metro.description);  // "Estação do Metrô Estação Sé"

const station = new ReferencePlace({
  class: 'railway',
  type: 'station',
  name: 'Estação da Luz'
});
console.log(station.description);  // "Estação do Metrô Estação da Luz"
```

---

#### 5. **Building** (`class: "building"`)
| Type | Portuguese | Description |
|------|-----------|-------------|
| `yes` | "Edifício" | Generic building |

**Example:**
```javascript
const building = new ReferencePlace({
  class: 'building',
  type: 'yes',
  name: 'Edifício Itália'
});
console.log(building.description);  // "Edifício Edifício Itália"
```

---

## Integration Examples

### Basic Usage

```javascript
import ReferencePlace from './data/ReferencePlace.js';

const data = {
  class: 'shop',
  type: 'mall',
  name: 'Shopping Recife'
};

const refPlace = new ReferencePlace(data);

console.log(refPlace.description);      // "Shopping Center Shopping Recife"
console.log(refPlace.name);             // "Shopping Recife"
console.log(refPlace.className);        // "shop"
console.log(refPlace.typeName);         // "mall"
console.log(refPlace.calculateCategory()); // "Shopping Center"
```

### With AddressExtractor

```javascript
import AddressExtractor from './data/AddressExtractor.js';

const geocodingData = {
  address: {
    road: "Avenida Boa Viagem",
    house_number: "5000",
    city: "Recife",
    state_code: "PE"
  },
  class: 'shop',
  type: 'mall',
  name: 'Shopping Recife'
};

const extractor = new AddressExtractor(geocodingData);
const address = extractor.enderecoPadronizado;
const refPlace = address.referencePlace;

console.log(refPlace.description);
// "Shopping Center Shopping Recife"
```

### Display in UI

```javascript
import ReferencePlace from './data/ReferencePlace.js';
import HTMLReferencePlaceDisplayer from './html/HTMLReferencePlaceDisplayer.js';

// Create reference place
const refPlace = new ReferencePlace({
  class: 'railway',
  type: 'subway',
  name: 'Estação Sé'
});

// Display in HTML
const displayer = new HTMLReferencePlaceDisplayer(refPlace, document);
displayer.display();

// Or manual display
if (refPlace.description !== NO_REFERENCE_PLACE) {
  const placeElement = document.getElementById('reference-place');
  placeElement.textContent = refPlace.description;
  placeElement.style.display = 'block';
}
```

### Handling Unknown Places

```javascript
import ReferencePlace from './data/ReferencePlace.js';
import { NO_REFERENCE_PLACE } from './config/defaults.js';

const unknownData = {
  class: 'tourism',
  type: 'hotel',
  name: 'Hotel Brasil'
};

const refPlace = new ReferencePlace(unknownData);

console.log(refPlace.description);
// "tourism: hotel" (fallback to class:type format)

// Check if place is classified
if (refPlace.description === NO_REFERENCE_PLACE) {
  console.log('No reference place available');
} else if (refPlace.description.includes(':')) {
  console.log('Unknown place type:', refPlace.description);
} else {
  console.log('Known place:', refPlace.description);
}
```

### Filtering by Category

```javascript
import ReferencePlace from './data/ReferencePlace.js';

const places = [
  new ReferencePlace({ class: 'shop', type: 'mall', name: 'Shopping A' }),
  new ReferencePlace({ class: 'amenity', type: 'cafe', name: 'Café B' }),
  new ReferencePlace({ class: 'railway', type: 'subway', name: 'Estação C' }),
  new ReferencePlace({ class: 'shop', type: 'mall', name: 'Shopping D' })
];

// Filter by category
const malls = places.filter(place => 
  place.calculateCategory() === 'Shopping Center'
);

console.log(malls.length);  // 2 (Shopping A and Shopping D)

// Group by category
const grouped = places.reduce((acc, place) => {
  const category = place.calculateCategory();
  if (!acc[category]) acc[category] = [];
  acc[category].push(place);
  return acc;
}, {});

console.log(grouped);
// {
//   "Shopping Center": [Shopping A, Shopping D],
//   "Café": [Café B],
//   "Estação do Metrô": [Estação C]
// }
```

---

## Extending the Mapping

To add new place types, extend the `referencePlaceMap`:

```javascript
// Add new shop type
ReferencePlace.referencePlaceMap.shop.supermarket = "Supermercado";

// Add new amenity type
ReferencePlace.referencePlaceMap.amenity.restaurant = "Restaurante";

// Add new class
ReferencePlace.referencePlaceMap.leisure = {
  park: "Parque",
  playground: "Parquinho"
};
```

**Note:** Also update `VALID_REF_PLACE_CLASSES` in `src/config/defaults.js` when adding new classes.

---

## Immutability

ReferencePlace instances are **frozen** after creation:

```javascript
const refPlace = new ReferencePlace(data);

// Cannot modify properties
refPlace.description = "New Description";  // ❌ Fails in strict mode
refPlace.name = "New Name";                // ❌ Fails in strict mode

console.log(Object.isFrozen(refPlace));    // true
```

**Rationale:**
- Follows MP Barbosa immutability standards
- Prevents accidental modification of extracted data
- Ensures referential transparency
- Supports functional programming patterns

---

## Configuration Constants

Referenced from `src/config/defaults.js`:

```javascript
export const NO_REFERENCE_PLACE = "Não classificado";

export const VALID_REF_PLACE_CLASSES = [
  'place',
  'shop', 
  'amenity',
  'railway',
  'building'
];
```

---

## Testing

Comprehensive test coverage in:
- `__tests__/unit/data/ReferencePlace.test.js`
- `__tests__/integration/reference-place.test.js`

**Example Test:**
```javascript
describe('ReferencePlace', () => {
  test('creates reference place with description', () => {
    const data = {
      class: 'shop',
      type: 'mall',
      name: 'Shopping Morumbi'
    };
    
    const refPlace = new ReferencePlace(data);
    
    expect(refPlace.className).toBe('shop');
    expect(refPlace.typeName).toBe('mall');
    expect(refPlace.name).toBe('Shopping Morumbi');
    expect(refPlace.description).toBe('Shopping Center Shopping Morumbi');
  });
  
  test('is frozen after creation', () => {
    const refPlace = new ReferencePlace({ class: 'shop', type: 'mall' });
    expect(Object.isFrozen(refPlace)).toBe(true);
  });
  
  test('calculates category correctly', () => {
    const refPlace = new ReferencePlace({ class: 'shop', type: 'mall' });
    expect(refPlace.calculateCategory()).toBe('Shopping Center');
  });
});
```

---

## Version History

### v0.8.5-alpha (Current)
- Initial implementation with OSM feature mapping
- Support for 5 OSM classes: place, shop, amenity, railway, building
- Immutable pattern with `Object.freeze()`
- Integration with `AddressExtractor` and display components

### v0.7.1-alpha
- Version info field added to module documentation
- Referenced in address validation tests

---

## Related Classes

- **`AddressExtractor`** - Creates ReferencePlace from geocoding data
- **`BrazilianStandardAddress`** - Contains referencePlace property
- **`HTMLReferencePlaceDisplayer`** - Renders reference place in UI

---

## See Also

- [ADDRESS_EXTRACTOR.md](./ADDRESS_EXTRACTOR.md) - Address extraction including reference places
- [BRAZILIAN_STANDARD_ADDRESS.md](./BRAZILIAN_STANDARD_ADDRESS.md) - Address data structure
- [OpenStreetMap Map Features](https://wiki.openstreetmap.org/wiki/Map_Features) - OSM feature documentation
