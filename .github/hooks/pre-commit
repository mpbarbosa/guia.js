#!/bin/bash
# Pre-commit Hook: Documentation Consistency Checker
# Installation: cp .github/hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}═══ Documentation Consistency Check (Pre-commit) ═══${NC}"
echo ""

# Check 1: Version Consistency
echo -e "${YELLOW}[1/5] Version consistency...${NC}"
VERSION_PATTERN="0\.7\.0-alpha"
VERSION_ERRORS=0

for file in README.md docs/INDEX.md .github/copilot-instructions.md src/config/defaults.js; do
    if [ -f "$file" ] && ! grep -q "$VERSION_PATTERN" "$file"; then
        echo -e "${RED}  ✗ $file: Version mismatch${NC}"
        VERSION_ERRORS=$((VERSION_ERRORS + 1))
    elif [ -f "$file" ]; then
        echo "  ✓ $file"
    fi
done

if [ $VERSION_ERRORS -gt 0 ]; then
    echo -e "${RED}✗ Version check failed!${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Versions consistent${NC}\n"

# Check 2: Test Count  
echo -e "${YELLOW}[2/5] Test count...${NC}"
for file in README.md .github/copilot-instructions.md; do
    if [ -f "$file" ] && grep -q "1399.*test" "$file"; then
        echo "  ✓ $file"
    fi
done
echo -e "${GREEN}✓ Test counts OK${NC}\n"

# Check 3: Auto-update dates
echo -e "${YELLOW}[3/5] Last Updated dates...${NC}"
TODAY=$(date +%Y-%m-%d)
for file in $(git diff --cached --name-only | grep '\.md$'); do
    if [ -f "$file" ] && grep -q "Last Updated:" "$file"; then
        if ! grep -q "Last Updated.*$TODAY" "$file"; then
            sed -i "s/Last Updated: .*/Last Updated: $TODAY/" "$file"
            git add "$file"
            echo "  ✓ Updated $file"
        fi
    fi
done
echo -e "${GREEN}✓ Dates current${NC}\n"

# Check 4: Broken links
echo -e "${YELLOW}[4/5] Markdown links...${NC}"
LINK_ERRORS=0
for file in $(git diff --cached --name-only | grep '\.md$'); do
    if [ ! -f "$file" ]; then continue; fi
    while IFS= read -r link; do
        if [ -n "$link" ]; then
            dir=$(dirname "$file")
            full_path="$dir/$link"
            if [ ! -f "$full_path" ]; then
                echo -e "${RED}  ✗ Broken: $link in $file${NC}"
                LINK_ERRORS=$((LINK_ERRORS + 1))
            fi
        fi
    done < <(grep -oP '\]\(\K[^)]+\.md(?=\))' "$file" 2>/dev/null || true)
done
if [ $LINK_ERRORS -gt 0 ]; then
    echo -e "${RED}✗ Broken links found${NC}"
    exit 1
fi
echo -e "${GREEN}✓ No broken links${NC}\n"

# Check 5: File references
echo -e "${YELLOW}[5/5] File references...${NC}"
FILE_ERRORS=0
for file in $(git diff --cached --name-only | grep '\.md$'); do
    if [ ! -f "$file" ]; then continue; fi
    while IFS= read -r ref; do
        if [ ! -f "$ref" ]; then
            echo -e "${RED}  ✗ Missing: $ref${NC}"
            FILE_ERRORS=$((FILE_ERRORS + 1))
        fi
    done < <(grep -oP 'src/[a-zA-Z0-9/_.-]+\.js' "$file" 2>/dev/null || true)
done
if [ $FILE_ERRORS -gt 0 ]; then
    echo -e "${RED}✗ Missing files${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Files verified${NC}\n"

echo -e "${GREEN}═══ ✓ All checks passed ═══${NC}"
exit 0
